package net.exploitables.slashlib;


import discord4j.core.event.domain.interaction.ChatInputInteractionEvent;
import discord4j.core.event.domain.interaction.MessageInteractionEvent;
import discord4j.core.event.domain.interaction.UserInteractionEvent;
import discord4j.core.object.entity.channel.GuildChannel;
import net.exploitables.slashlib.context.*;
import reactor.core.publisher.Mono;

public class InteractionEventReceiverImpl implements InteractionEventReceiver {
    @Override
    public Mono<ChatInputInteractionContext> receiveChatInputInteractionEvent(ChatInputInteractionEvent event) {
        // We need the command interaction to get the options
        return Mono.justOrEmpty(event.getInteraction().getCommandInteraction())
            // Get the command, we use the helper method on the command Structure to get this as
            //  chat input commands care multi-level
            .flatMap(aci -> Mono.just(SlashLib.get().getCommandRegister().getCommandStructure().searchForChatCommand(aci))
                // Check bot permissions in guild
                .flatMap(pair -> event.getInteraction()
                    .getChannel()
                    .ofType(GuildChannel.class)
                    .flatMap(gc -> gc.getEffectivePermissions(event.getClient().getSelfId()))
                    .filter(perms -> perms.containsAll(pair.getKey().getBotPermissions()))
                    // No perms, send silent error message
                    .switchIfEmpty(event.reply("I need the following permissions for that command: " +
                        pair.getKey().getBotPermissions().asEnumSet())
                        .withEphemeral(true)
                        .then(Mono.empty()))
                    // Have perms, create the builder and collect data
                    .flatMap(_perms -> pair.getKey().setRequestData(new ChatInputInteractionContextBuilder(event, aci, pair.getValue()))
                        .collectData()
                        .ofType(ChatInputInteractionContextBuilder.class)
                        .map(ChatInputInteractionContextBuilder::build)
                        // Call the command
                        .flatMap(context -> pair.getKey().executeChat(context)))));
}

    @Override
    public Mono<UserInteractionContext> receiveUserInteractionEvent(UserInteractionEvent event) {
        // Since User Interactions are only top level we can just get our command by the name
        return Mono.just(SlashLib.get().getCommandRegister().getCommandStructure().getUserCommands().get(event.getCommandName()))
            // Check bot permissions in guild
            .flatMap(userCommand -> event.getInteraction()
                .getChannel()
                .ofType(GuildChannel.class)
                .flatMap(gc -> gc.getEffectivePermissions(event.getClient().getSelfId()))
                .filter(perms -> perms.containsAll(userCommand.getBotPermissions()))
                // No perms, send silent error message
                .switchIfEmpty(event.reply("I need the following permissions for that command: " +
                    userCommand.getBotPermissions().asEnumSet())
                    .withEphemeral(true)
                    .then(Mono.empty()))
                // Have perms, create the builder and collect data
                .flatMap(_perms -> userCommand.setRequestData(new UserInteractionContextBuilder(event))
                    .collectData()
                    .ofType(UserInteractionContextBuilder.class)
                    .map(UserInteractionContextBuilder::build)
                    // Call the command
                    .flatMap(userCommand::executeUser)));
    }

    @Override
    public Mono<MessageInteractionContext> receiveMessageInteractionEvent(MessageInteractionEvent event) {
        // Since User Interactions are only top level we can just get our command by the name
        return Mono.just(SlashLib.get().getCommandRegister().getCommandStructure().getMessageCommands().get(event.getCommandName()))
            // Check bot permissions in guild
            .flatMap(messageCommand -> event.getInteraction()
                .getChannel()
                .ofType(GuildChannel.class)
                .flatMap(gc -> gc.getEffectivePermissions(event.getClient().getSelfId()))
                .filter(perms -> perms.containsAll(messageCommand.getBotPermissions()))
                // No perms, send silent error message
                .switchIfEmpty(event.reply("I need the following permissions for that command: " +
                    messageCommand.getBotPermissions().asEnumSet())
                    .withEphemeral(true)
                    .then(Mono.empty()))
                // Have perms, create the builder and collect data
                .flatMap(_perms -> messageCommand.setRequestData(new MessageInteractionContextBuilder(event))
                    .collectData()
                    .ofType(MessageInteractionContextBuilder.class)
                    .map(MessageInteractionContextBuilder::build)
                    // Call the command
                    .flatMap(messageCommand::executeMessage)));
    }
}
