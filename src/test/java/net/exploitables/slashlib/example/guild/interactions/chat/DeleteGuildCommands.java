package net.exploitables.slashlib.example.guild.interactions.chat;

import discord4j.rest.service.ApplicationService;
import net.exploitables.slashlib.commands.standard.TopCommand;
import net.exploitables.slashlib.context.ChatContext;
import net.exploitables.slashlib.context.ChatContextBuilder;
import net.exploitables.slashlib.example.guild.GuildExampleBot;
import reactor.core.publisher.Mono;

/**
 * An example command that directly deletes all guild commands on the guild it's called in.
 * Primarily used for cleaning up after testing.
 */
public class DeleteGuildCommands extends TopCommand {
    public DeleteGuildCommands() {
        super("delete-guild-cmds", "delete all guild commands for this guild");
    }

    @Override
    public Mono<ChatContext> executeChat(ChatContext context) {
        ApplicationService applicationService = GuildExampleBot.getDiscordClient().getApplicationService();
        long applicationId = GuildExampleBot.getApplicationId();
        // We've required the guild be present
        //noinspection OptionalGetWithoutIsPresent
        long guildId = context.getGuild().get().getId().asLong();

        return applicationService
            .getGuildApplicationCommands(GuildExampleBot.getApplicationId(), guildId)
            .flatMap(acd -> applicationService.deleteGuildApplicationCommand(applicationId, guildId, Long.parseLong(acd.id())).thenReturn(1))
            .count()
            .flatMap(deletedCount -> context.getEvent().reply("Deleted " + deletedCount + " Guild Commands."))
            .thenReturn(context);
    }

    @Override
    public ChatContextBuilder setRequestData(ChatContextBuilder builder) {
        return (ChatContextBuilder) builder.requireGuild();
    }
}
