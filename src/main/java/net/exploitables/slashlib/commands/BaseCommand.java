package net.exploitables.slashlib.commands;

import discord4j.core.object.command.ApplicationCommand;
import discord4j.core.object.command.ApplicationCommandOption;
import discord4j.discordjson.json.ApplicationCommandOptionData;
import discord4j.discordjson.json.ApplicationCommandRequest;
import discord4j.discordjson.json.ImmutableApplicationCommandRequest;
import discord4j.rest.util.Permission;
import discord4j.rest.util.PermissionSet;
import net.exploitables.slashlib.context.SlashCommandContext;
import net.exploitables.slashlib.context.SlashCommandContextBuilder;
import reactor.core.publisher.Mono;
import reactor.util.annotation.Nullable;

import java.util.HashMap;
import java.util.Map;

/**
 * A class which represents all types of Slash Commands. This class should not be directly extended.
 */
public abstract class BaseCommand {
    // Command Name
    private final String name;
    // Command Description
    private final String description;
    // never null: The type of command this is (chat, user, message)
    private final ApplicationCommand.Type commandType;
    // If anyone can use this command by default
    private boolean defaultPermission;
    // Permissions needed by the bot
    private PermissionSet botPermissions;

    // null when not GroupCommand: SubCommands and Sub-GroupCommands
    protected final Map<String, BaseCommand> subCommands;

    protected BaseCommand(String name,
                          String description,
                          @Nullable ApplicationCommandOption.Type type,
                          ApplicationCommand.Type commandType) {
        this.name = name;
        this.description = description;
        this.commandType = commandType;

        this.defaultPermission = true;
        this.botPermissions = PermissionSet.none();

        if (type == ApplicationCommandOption.Type.SUB_COMMAND_GROUP) {
            this.subCommands = new HashMap<>();
        } else {
            this.subCommands = null;
        }
    }

    public abstract Mono<SlashCommandContext> execute(SlashCommandContext context);

    public abstract SlashCommandContextBuilder setRequestData(SlashCommandContextBuilder context);

    public abstract ApplicationCommandOptionData asOptionData();

    public abstract ApplicationCommandRequest asRequest();

    /**
     * @return a starting {@link ImmutableApplicationCommandRequest.Builder} with common properties
     */
    protected ImmutableApplicationCommandRequest.Builder buildBaseRequest() {
        ImmutableApplicationCommandRequest.Builder builder = ApplicationCommandRequest.builder()
                .type(this.getCommandType().getValue())
                .name(this.getName())
                .description(this.getDescription());
        if (!this.isDefaultPermission()) { // Avoid the need to check false against an absent possible
            builder.defaultPermission(false);
        }
        return builder;
    }

    /**
     * Get a sub command of this command, only searches one level
     *
     * @param name the name of the sub command to get
     * @return the sub command if present, null if missing
     */
    public BaseCommand getSubCommand(String name) {
        return subCommands.getOrDefault(name, null);
    }

    /**
     * Set that this command requires a permission to be set for users to call it.
     */
    protected void setDefaultPermissionFalse() {
        this.defaultPermission = false;
    }

    /**
     * Set the permissions the bot needs to execute this command.
     *
     * @param permissions a unique list of Discord permissions
     */
    protected void setBotPermissions(Permission... permissions) {
        this.botPermissions = PermissionSet.of(permissions);
    }

    public String getName() { return name; }
    public String getDescription() { return description; }
    public ApplicationCommand.Type getCommandType() { return commandType; }
    public boolean isDefaultPermission() { return defaultPermission; }
    public PermissionSet getBotPermissions() { return botPermissions; }
    public Map<String, BaseCommand> getSubCommands() { return subCommands; }
}
