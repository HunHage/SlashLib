package net.exploitables.slashlib.context;

import discord4j.core.event.domain.interaction.MessageInteractionEvent;
import discord4j.core.object.entity.Guild;
import discord4j.core.object.entity.Member;
import discord4j.core.object.entity.Message;
import discord4j.core.object.entity.User;
import discord4j.core.object.entity.channel.MessageChannel;
import discord4j.core.object.entity.channel.TopLevelGuildChannel;
import reactor.core.publisher.Mono;

/**
 * A builder class provided to user commands before the command logic is called.
 */
public class MessageInteractionContextBuilder extends ContextBuilder {
    final MessageInteractionEvent event;

    Guild guild;
    MessageChannel messageChannel;
    TopLevelGuildChannel guildChannel;
    Message targetMessage;
    User messageAuthor;
    Member messageAuthorAsMember;
    User callingUser;
    Member callingUserAsMember;

    public MessageInteractionContextBuilder(MessageInteractionEvent event) {
        this.event = event;

        this.guild = null;
        this.messageChannel = null;
        this.guildChannel = null;
        this.targetMessage = null;
        this.messageAuthor = null;
        this.messageAuthorAsMember = null;
        this.callingUser = null;
        this.callingUserAsMember = null;
    }

    public MessageInteractionContext build() {
        return new MessageInteractionContext(this);
    }

    public MessageInteractionContextBuilder requireGuild() {
        requiredMonoList.add(event.getInteraction().getGuild()
            .doOnNext(guild -> this.guild = guild)
            .map(guild -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireChannel() {
        requiredMonoList.add(event.getInteraction().getChannel()
            .doOnNext(channel -> this.messageChannel = channel)
            .map(channel -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireGuildChannel() {
        requiredMonoList.add(event.getInteraction().getChannel()
            .doOnNext(channel -> this.messageChannel = channel)
            .ofType(TopLevelGuildChannel.class)
            .doOnNext(channel -> this.guildChannel = channel)
            .map(channel -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireMessage() {
        requiredMonoList.add(event.getTargetMessage()
            .doOnNext(message -> this.targetMessage = message)
            .map(member -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireMessageAuthor() {
        requiredMonoList.add(event.getTargetMessage()
            .doOnNext(message -> this.targetMessage = message)
            .flatMap(message -> Mono.justOrEmpty(message.getAuthor()))
            .doOnNext(user -> this.messageAuthor = user)
            .map(member -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireMessageAuthorAsMember() {
        // As of D4J v3.2.0 message#getAuthorAsMember() will get the guild
        requiredMonoList.add(event.getTargetMessage()
            .doOnNext(message -> this.targetMessage = message)
            .flatMap(message -> message.getGuild()
                .doOnNext(guild -> this.guild = guild)
                .flatMap(guild -> Mono.justOrEmpty(message.getAuthor())
                    .doOnNext(author -> this.messageAuthor = author)
                    .flatMap(author -> guild.getMemberById(author.getId()))
                    .doOnNext(member -> this.messageAuthorAsMember = member)))
            .map(member -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireCallingUser() {
        requiredMonoList.add(Mono.justOrEmpty(event.getInteraction().getUser())
            .doOnNext(user -> this.callingUser = user)
            .map(member -> 1));
        return this;
    }

    public MessageInteractionContextBuilder requireCallingMember() {
        requiredMonoList.add(Mono.justOrEmpty(event.getInteraction().getMember())
            .doOnNext(member -> this.callingUserAsMember = member)
            .map(member -> 1));
        return this;
    }
}
