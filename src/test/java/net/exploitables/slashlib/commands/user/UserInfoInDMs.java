package net.exploitables.slashlib.commands.user;

import discord4j.core.spec.EmbedCreateSpec;
import discord4j.core.spec.InteractionApplicationCommandCallbackSpec;
import net.exploitables.slashlib.commands.UserCommand;
import net.exploitables.slashlib.context.UserInteractionContext;
import net.exploitables.slashlib.context.UserInteractionContextBuilder;
import reactor.core.publisher.Mono;

import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.time.format.FormatStyle;

/**
 * Demo command to return an embed with various information about the entities provided
 *  with the user commands.
 *
 * This Demo is designed to work in DMs, however it is NOT the proper way to do so.
 * This Demo takes up an entire second command slot where the logic could be shared with a few "if" statements.
 */
public class UserInfoInDMs extends UserCommand {
    private static final DateTimeFormatter formatter = DateTimeFormatter
            .ofLocalizedDateTime(FormatStyle.SHORT).withZone(ZoneId.of("UTC"));

    public UserInfoInDMs() {
        super("Info in DMs");
        setUsableInDMs(); // Set that this command can be used in DMs, this overrides permission requirements.
    }

    @Override
    public Mono<UserInteractionContext> executeUser(UserInteractionContext context) {
        EmbedCreateSpec.Builder embed = EmbedCreateSpec.builder();
        embed.title("Info - User Context Command in DMs");
        embed.description("Displaying various collected information.");

        embed.addField("Channel",
            "```" +
            "      ID: " + context.getMessageChannel().getId().asString() + "\n" +
            " Created: " + formatter.format(context.getMessageChannel().getId().getTimestamp()) +
            "```",
            true);

        // Just to make the output look pretty
        embed.addField("Current Time",
            "```" +
            formatter.format(Instant.now()) +
            "```",
            false);

        embed.addField("Calling User",
            "```" +
            "      ID: " + context.getCallingUser().getId().asString() + "\n" +
            "    Name: " + context.getCallingUser().getUsername() + "#" + context.getCallingUser().getDiscriminator() + "\n" +
            " Created: " + formatter.format(context.getCallingUser().getId().getTimestamp()) +
            "```",
            true);

        embed.addField("Target User",
            "```" +
            "      ID: " + context.getTargetUser().getId().asString() + "\n" +
            "    Name: " + context.getTargetUser().getUsername() + "#" + context.getCallingUser().getDiscriminator() + "\n" +
            " Created: " + formatter.format(context.getTargetUser().getId().getTimestamp()) +
            "```",
            true);

        return context.getEvent()
            .reply(InteractionApplicationCommandCallbackSpec.builder().addEmbed(embed.build()).build())
            .thenReturn(context);
    }

    @Override
    public UserInteractionContextBuilder setRequestData(UserInteractionContextBuilder builder) {
        // You DO NOT need to call everything like this, some of these methods imply others and calling
        //  all of them is redundant. ex: requireTargetMember also gets the target user.
        // This is done as a form of test.
        return builder
            .requireChannel()
            .requireTargetUser()
            .requireCallingUser();
    }
}
