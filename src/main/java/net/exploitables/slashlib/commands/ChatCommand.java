package net.exploitables.slashlib.commands;

import discord4j.core.object.command.ApplicationCommand;
import discord4j.core.object.command.ApplicationCommandOption;
import discord4j.discordjson.json.ApplicationCommandOptionData;
import discord4j.discordjson.json.ApplicationCommandRequest;
import discord4j.discordjson.json.ImmutableApplicationCommandOptionData;
import discord4j.discordjson.json.ImmutableApplicationCommandRequest;
import reactor.util.annotation.Nullable;

import java.util.ArrayList;
import java.util.List;
import java.util.function.Consumer;

public abstract class ChatCommand extends BaseCommand {
    // null when TopCommand: The type of chat input command this is
    private final ApplicationCommandOption.Type chatType;
    // null when no options: Options for the command
    private List<ApplicationCommandOptionData> options;

    protected ChatCommand(String name,
                          String description,
                          @Nullable ApplicationCommandOption.Type type) {
        super(name, description, type, ApplicationCommand.Type.CHAT_INPUT);
        this.chatType = type;
        this.options = null;
    }

    /**
     * @return a representative {@link ApplicationCommandOptionData} of this class to be used as option data
     */
    @Override
    public ApplicationCommandOptionData asOptionData() {
        ImmutableApplicationCommandOptionData.Builder builder = ApplicationCommandOptionData.builder()
                .name(this.getName())
                .description(this.getDescription())
                .type(this.getChatType().getValue());
        List<ApplicationCommandOptionData> options = this.getOptions();
        if (options != null) {
            builder.options(options);
        }
        return builder.build();
    }

    /**
     * @return a representative {@link ApplicationCommandRequest} to compare/create this data with Discord
     */
    @Override
    public ApplicationCommandRequest asRequest() {
        // Get a builder with common values created and add the options for this command if present
        ImmutableApplicationCommandRequest.Builder builder = this.buildBaseRequest();
        if (this.getOptions() != null) {
            builder.addAllOptions(this.getOptions());
        }
        return builder.build();
    }

    /**
     * @param option an {@link ApplicationCommandOptionData} to add to this command
     */
    public void addOption(ApplicationCommandOptionData option) {
        if (this.options == null) this.options = new ArrayList<>();
        this.options.add(option);
    }

    /**
     * @param option an {@link ApplicationCommandOptionData} builder consumer to add to this command
     */
    public void addOption(Consumer<ImmutableApplicationCommandOptionData.Builder> option) {
        ImmutableApplicationCommandOptionData.Builder builder = ApplicationCommandOptionData.builder();
        option.accept(builder);
        this.addOption(builder.build());
    }

    public List<ApplicationCommandOptionData> getOptions() { return options; }
    public ApplicationCommandOption.Type getChatType() { return chatType; }
}
